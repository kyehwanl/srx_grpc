
Compilation Orders for grpc enabled srx development
===================================================

1. Install go, grpc plugins for go and protocol buffer

  (1) golang 
      yum -y install golang

  (2) plugins
      go get -u github.com/golang/protobuf/protoc-gen-go
      go get -u google.golang.org/grpc

  (3) protocol buffer
      wget https://github.com/protocolbuffers/protobuf/releases/download/v3.6.1/protoc-3.6.1-linux-x86_64.zip
      unzip protoc-3.6.1-linux-x86_64.zip
      cp protoc /usr/bin/
      cp -rf include/* /usr/include/

  (4) set for GOPATH environment variable and put it in .bash_profile
      export GOPATH=/root/go
      PATH=$PATH:$GOPATH/bin
      export PATH



2. Download 'srx-grpc' from github

  (1) srx_grpc 
      git clone https://github.com/kyehwanl/srx_grpc.git

  (2) for crypto-api, download NIST SRx as well
      git clone --depth=1 https://github.com/usnistgov/NIST-BGP-SRx.git
      

  (3) for compilation of api and srx server, need dependent libraries

      yum -y install epel-release
      yum -y install tmux vim git gcc automake autoconf libtool vifm psmisc readline-devel patch
      yum -y install wget libconfig libconfig-devel openssl openssl-devel libcrypto.so.* less gcc uthash-devel



3. generate service libraries in srx server and client directories

  (1) place header files
      - When compilation of api, the installation directory is to be made with '_inst' below
      ./configure --prefix=$PWD/../_inst CFLAGS="-g -O0"

      - put 'srxcryptoapi.h, srx_api.h' into _inst/include/srx
      srx_api.h is obtained srx/src/client/

  (2) srx server --> libgrpc_service.so
      gcc -DHAVE_CONFIG_H -fPIC -shared -o server/libgrpc_service.so server/grpc_service.c \
          -I${GOPATH}/src/srx_grpc/srx/src \
          -I${GOPATH}/src/srx_grpc/srx/src/../extras/local/include \
          -I${GOPATH}/src/srx_grpc/srx/../_inst/include
          -I/opt/project/srx_test1/srx/../_inst/include


  (3) srx client --> libgrpc_client_service.so
      gcc -DHAVE_CONFIG_H -fPIC -shared -o client/libgrpc_client_service.so client/grpc_client_service.c \
          -I${GOPATH}/opt/project/gobgp_test/gowork/src/srx_grpc/srx/src \
          -I${GOPATH}/opt/project/gobgp_test/gowork/src/srx_grpc/srx/src/../extras/local/include \
          -I${GOPATH}/src/srx_grpc/srx/../_inst/include
          -I/opt/project/srx_test1/srx/../_inst/include


4. generate grpc client library
  (0) first, it may need log.o in srx server, because srx_grpc_client.go has cgo option for LDFLAGS which needs log.o
      - it can be obtained 
          -- by compilation of srx server, even though it might fail to compilation with errors
          -- partially gcc compile for log.c
       

  (1) client: modify Makefile and srx_grpc_client.go in client directory according to GOPATH 

      <Makefile>
          go build -gcflags '-N -l' srx_grpc_client.go
          go build -gcflags '-N -l' -buildmode=c-shared -o libsrx_grpc_client.so  srx_grpc_client.go
          gcc -g -O0 -o CImple_srx_grpc_client CImple_srx_grpc_client.c ./libsrx_grpc_client.so \
                  -I/root/go/src/srx_grpc/srx/../_inst/include/srx \
                  -I/root/go/src/srx_grpc/srx/../_inst/include/ \
                  -I/root/go/src/srx_grpc/srx/src/ \
                  -I/root/go/src/srx_grpc/srx/src/../extras/local/include \
                  -Wl,--unresolved-symbols=ignore-all -lpthread

      <srx_grpc_client.go> 
      #cgo CFLAGS: -I/root/go/src/srx_grpc/srx/../_inst/include/ \ 
                   -I/root/go/src/srx_grpc/srx/src/ \ 
                   -I/root/go/src/srx_grpc/srx/src/../extras/local/include \ 
                   -I/opt/project/srx_test1/srx/../_inst//include
      #cgo LDFLAGS: /root/go/src/srx_grpc/srx/src/.libs/log.o \
                  -L/root/go/src/srx_grpc/srx/src/.libs -lgrpc_client_service \
                  -Wl,-rpath -Wl,/root/go/src/srx_grpc/srx/src/.libs -Wl,--unresolved-symbols=ignore-all


  (2) compile with Makefile and genenrate libsrx_grpc_client.so which will be linked with srx server proxy later



5. generate grpc server library
  (1) modify Makefile and srx_grpc_client.go in client directory according to GOPATH 

      <Makefile>
          go build -gcflags '-N -l' srx_grpc_server.go
          go build -gcflags '-N -l' -buildmode=c-shared -o libsrx_grpc_server.so  srx_grpc_server.go
          gcc -g -O0 -o CImple_srx_grpc_server CImple_srx_grpc_server.c ./libsrx_grpc_server.so \
          -I/root/go/src/srx_grpc/srx/../_inst/include/srx \
          -I/root/go/src/srx_grpc/srx/../_inst/include/ \
          -I/root/go/src/srx_grpc/srx/src/ \
          -I/root/go/src/srx_grpc/srx/src/../extras/local/include \
          -Wl,--unresolved-symbols=ignore-all



      <srx_grpc_server.go> 
          #cgo CFLAGS: -I/root/go/src/srx_grpc/srx/../_inst/include/ \
                      -I/root/go/src/srx_grpc/srx/src/ \
                      -I/root/go/src/srx_grpc/srx/src/../extras/local/include
          #cgo LDFLAGS: -L/root/go/src/srx_grpc/srx/src/.libs -lgrpc_service \
                      -Wl,-rpath -Wl,/root/go/src/srx_grpc/srx/src/.libs -Wl,--unresolved-symbols=ignore-all



6. compile for srx server

  (1) command
      ./configure --disable-option-checking --prefix=$PWD/../_inst sca_dir=$PWD/../_inst/ \
       --cache-file=/dev/null --srcdir=. --enable-grpc grpc_dir=/root/go/src/srx_grpc
      make all install







7. Running

  (1) client - srxsvr_client

      proxy: 0x1e2b260,  proxy ID [defaul]: 0a000001, grpcEnabled[1]                    
      + pthread grpc service started...
      [ImpleGoStreamThread:682] arguments proxy: 0x1e2b260, proxyID: 0a000001
      + GoodBye Stream Thread created 
      Run Proxy Good Bye Stream 
      [GoodByeStreamThread:622] arguments proxy: 0x1e2b260, proxyID: 0a000001
      Run Proxy Stream 
      [StreamThread:645] arguments proxy: 0x1e2b260, proxyID: 0a000001
      + General Purpose Stream Thread created 
      + General Purpose Stream Thread created 
      SRX API Test Harness Version 0.3

      >> connect_grpc localhost 17900 4 65011                                                                                                 
      PeerAS (enter for stop) ? 
      Connection to localhost is successfully established!

      >> verify_grpc 1 3 65011 100.2.0.0/24 3 3 quit
      >> => Received validation result for update [uid=0xE2D4FC8F;lid:0x00000001]:  ROA=NOT DEFINED;  BGPSEC=NOT DEFINED
      >> => Received validation result for update [uid=0xE2D4FC8F;lid:0x00000000]:  BGPSEC=INVALID

      >> quit
      Release proxy 0.0.0.4 [0x00000004] (4)


      send Goodbye! called

      + [sendGoodbye_grpc] :605 
      Received a communication code [129] subcode:0.
      Goodbye!


  (2) run srx_server first
      [SRxCryptoAPI - INFO] The internal key initialized storage holds (11 private and 6 public keys)!
      WARNING [10/15/21 02:54.05] The loaded srx-crypto-api plug-in does not support remote control of LOGING configuration - Use API configuration to do so!
         INFO [10/15/21 02:54.05] - SRx Caches and RPKI Queue created
         INFO [10/15/21 02:54.05] Register proxyID[0x00000002] as clientID[0x00000001]
         INFO [10/15/21 02:54.05] Register proxyID[0x0A000001] as clientID[0x0000000A]
         INFO [10/15/21 02:54.05] Register proxyID[0x0A010102] as clientID[0x00000019]
         INFO [10/15/21 02:54.05] - All Handlers created
         INFO [10/15/21 02:54.05] - Command Queue created!
         INFO [10/15/21 02:54.05] Received an end of data, process RPKI Queue:

         INFO [10/15/21 02:54.05] Server console on port [17901] created.
         INFO [10/15/21 02:54.05] ([0x00000035] Main): + pthread grpc service started...

         INFO [10/15/21 02:54.05] ([0x00000035] Main): grpc service thread STOPPED and going to joinable status
         INFO [10/15/21 02:54.05] ([0x00000035] Main): + pthread grpc service thread stopped and going to joinable status

         INFO [10/15/21 02:54.05] ([0x00000035] Main): [server] created GRPC Service thread

         INFO [10/15/21 02:54.05] SRX server running, control via telnet on port 17901
         INFO [10/15/21 02:54.05] ([0xA2FFD700] Main): ([0x00000001]) > gRPC Server Thread started
         INFO [10/15/21 02:54.05] ([0x00000035] Main): ++ pthread grpc service thread started...

         INFO [10/15/21 02:54.26] ([0x00000006] GRPC_ServiceHandler): srx server log Level: 0

  ----------------------------------------------------------
  ==> client command :  connect_grpc localhost 17900 4 65011
  ----------------------------------------------------------
      00 00 02 00 00 00 00 14 00 00 00 04 00 00 00 32
      00 00 00 00
         INFO [10/15/21 02:54.26] Register proxyID[0x00000004] as clientID[0x00000002]
         INFO [10/15/21 02:54.26] ([0x00000004] GRPC_ServiceHandler): [SRx server] proxyID: 2 --> mapping[clientID:-1946154784] cthread: (nil)

         INFO [10/15/21 02:54.26] Handshake: Connection to proxy[0x00000004] accepted. Proxy registered as internal client[0x02]



  -----------------------------------------------------------------
  ==> client command :  verify_grpc 1 3 65011 100.2.0.0/24 3 3 quit
  -----------------------------------------------------------------
         INFO [10/15/21 02:54.43] ([0x00000006] GRPC_ServiceHandler): srx server log Level: 0


      03 83 03 03 00 00 00 a9 03 03 00 18 00 00 00 01
      64 02 00 00 00 00 fd f3 00 00 00 71 00 01 00 6d
      00 01 01 00 00 00 00 00 00 00 00 00 00 00 00 00
      00 00 00 00 00 00 fd ed 00 00 fd f3 90 21 00 69
      00 08 01 00 00 00 fd f3 00 61 01 c3 04 33 fa 19
      75 ff 19 31 81 45 8f b9 02 b5 01 ea 97 89 dc 00
      48 30 46 02 21 00 bd 92 9e 69 35 6e 7b 6c fe 1c
      bc 3c bd 1c 4a 63 8d 64 5f a0 b7 20 7e f3 2c cc
      4b 3f d6 1b 5f 46 02 21 00 b6 0a 7c 82 7f 50 e6
      5a 5b d7 8c d1 81 3d bc ca a8 2d 27 47 60 25 e0
      8c da 49 f9 1e 22 d8 c0 8e
         INFO [10/15/21 02:54.43] ([0xAA102700] GRPC_ServiceHandler): Enter processValidationRequest
         INFO [10/15/21 02:54.43] ([0x00000003] GRPC_ServiceHandler): + from updata cache srxRes.roaResult : 00

         INFO [10/15/21 02:54.43] ([0x00000003] GRPC_ServiceHandler): + from updata cache srxRes.bgpsecResult : 00

         INFO [10/15/21 02:54.43] ([0xAA102700] GRPC_ServiceHandler): Exit processValidationRequest
      [SRxCryptoAPI - DEBUG] NO KEY -> VERIFY FAILED (SKI: C30433FA)
         INFO [10/15/21 02:54.50] ([0x00000006] GRPC_ServiceHandler): srx server log Level: 0


  ---------------------------
  ==> client command :  quit
  ---------------------------
      02 03 84 00 00 00 00 08
         INFO [10/15/21 02:54.50] Client connection [ID:4] closed!




















